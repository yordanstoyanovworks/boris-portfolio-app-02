<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Investment Portfolio Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <style>
    /* [ALL THE ORIGINAL CSS STAYS HERE - 799 LINES] */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1a1625 0%, #2d1b3d 50%, #1a2820 100%); color: #e0e0e0; padding: 40px; min-height: 100vh; }
    /* ... rest of CSS ... */
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Portfolio Overview</h1>
      <p class="subtitle">Last updated: <span id="lastUpdated">February 7, 2026</span></p>
      <div style="margin-top: 10px; font-size: 12px; color: #888;">
        <span id="connectionStatus">üî¥ Disconnected from database</span>
        <span id="saveStatus" style="margin-left: 20px;"></span>
      </div>
    </header>
    
    <!-- [ALL THE ORIGINAL HTML STAYS HERE] -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-label">Total Value</div>
        <div class="metric-value" id="totalValue"></div>
        <div class="metric-change positive" id="totalGain"></div>
      </div>
      <!-- ... rest of HTML ... -->
    </div>
    
    <!-- [MODALS AND ALL OTHER ELEMENTS] -->
  </div>

  <!-- Supabase Configuration -->
  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://vkmprvarnomjlmlhgcqs.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_plDGxi0yTUxQF8GXPRHwjA_TwSLsvO1';
    
    // Initialize Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Connection status
    let isConnected = false;
    let currentPortfolioId = null;
    
    // Update connection status
    function updateConnectionStatus() {
      const statusEl = document.getElementById('connectionStatus');
      const saveEl = document.getElementById('saveStatus');
      
      if (isConnected) {
        statusEl.innerHTML = 'üü¢ Connected to database';
        statusEl.style.color = '#10b981';
      } else {
        statusEl.innerHTML = 'üî¥ Disconnected from database';
        statusEl.style.color = '#ef4444';
      }
    }
    
    // Test connection on load
    async function testConnection() {
      try {
        const { data, error } = await supabase.from('portfolios').select('id').limit(1);
        if (error) throw error;
        
        isConnected = true;
        console.log('‚úÖ Supabase connected successfully');
        
        // Try to load or create portfolio
        await loadOrCreatePortfolio();
      } catch (error) {
        console.error('‚ùå Supabase connection failed:', error.message);
        isConnected = false;
      }
      updateConnectionStatus();
    }
    
    // Load or create portfolio
    async function loadOrCreatePortfolio() {
      try {
        // Try to get existing portfolio (we'll use the first one for now)
        const { data: portfolios, error } = await supabase
          .from('portfolios')
          .select('*')
          .limit(1);
        
        if (error) throw error;
        
        if (portfolios && portfolios.length > 0) {
          // Load existing portfolio
          currentPortfolioId = portfolios[0].id;
          console.log('üìä Loaded portfolio:', currentPortfolioId);
          
          // Load holdings for this portfolio
          await loadHoldings();
        } else {
          // Create new portfolio
          const { data: newPortfolio, error: createError } = await supabase
            .from('portfolios')
            .insert([{
              name: 'Main Portfolio',
              description: 'Default investment portfolio',
              currency: 'EUR'
            }])
            .select()
            .single();
          
          if (createError) throw createError;
          
          currentPortfolioId = newPortfolio.id;
          console.log('üìä Created new portfolio:', currentPortfolioId);
          
          // Save initial holdings
          await saveHoldings();
        }
        
        updateLastUpdated();
      } catch (error) {
        console.error('‚ùå Error loading/creating portfolio:', error.message);
      }
    }
    
    // Load holdings from Supabase
    async function loadHoldings() {
      if (!currentPortfolioId) return;
      
      try {
        const { data: holdingsData, error } = await supabase
          .from('holdings')
          .select('*')
          .eq('portfolio_id', currentPortfolioId)
          .order('created_at', { ascending: true });
        
        if (error) throw error;
        
        if (holdingsData && holdingsData.length > 0) {
          // Convert database holdings to our format
          holdings = holdingsData.map(h => ({
            id: h.id,
            name: h.name,
            ticker: h.ticker,
            country: h.country,
            tradeCcy: h.currency,
            invested: parseFloat(h.invested_amount),
            current: parseFloat(h.current_value)
          }));
          
          nextId = Math.max(...holdings.map(h => h.id)) + 1;
          console.log(`üìä Loaded ${holdings.length} holdings from database`);
          render();
        }
      } catch (error) {
        console.error('‚ùå Error loading holdings:', error.message);
      }
    }
    
    // Save holdings to Supabase
    async function saveHoldings() {
      if (!currentPortfolioId) return;
      
      try {
        // Delete existing holdings
        const { error: deleteError } = await supabase
          .from('holdings')
          .delete()
          .eq('portfolio_id', currentPortfolioId);
        
        if (deleteError) throw deleteError;
        
        // Insert new holdings
        const holdingsToSave = holdings.map(h => ({
          portfolio_id: currentPortfolioId,
          name: h.name,
          ticker: h.ticker,
          country: h.country,
          currency: h.tradeCcy,
          invested_amount: h.invested,
          current_value: h.current
        }));
        
        const { error: insertError } = await supabase
          .from('holdings')
          .insert(holdingsToSave);
        
        if (insertError) throw insertError;
        
        console.log(`üíæ Saved ${holdings.length} holdings to database`);
        updateSaveStatus('üíæ Saved to database');
        updateLastUpdated();
      } catch (error) {
        console.error('‚ùå Error saving holdings:', error.message);
        updateSaveStatus('‚ùå Save failed');
      }
    }
    
    // Update save status
    function updateSaveStatus(message) {
      const saveEl = document.getElementById('saveStatus');
      saveEl.textContent = message;
      saveEl.style.color = message.includes('‚ùå') ? '#ef4444' : '#10b981';
      
      // Clear after 3 seconds
      setTimeout(() => {
        if (saveEl.textContent === message) {
          saveEl.textContent = '';
        }
      }, 3000);
    }
    
    // Update last updated time
    function updateLastUpdated() {
      const now = new Date();
      const options = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      document.getElementById('lastUpdated').textContent = now.toLocaleDateString('en-US', options);
    }
    
    // Modify existing saveHolding function to auto-save
    const originalSaveHolding = window.saveHolding;
    window.saveHolding = function() {
      originalSaveHolding();
      if (isConnected) {
        setTimeout(() => saveHoldings(), 500);
      }
    };
    
    // Modify existing confirmDelete function to auto-save
    const originalConfirmDelete = window.confirmDelete;
    window.confirmDelete = function() {
      originalConfirmDelete();
      if (isConnected) {
        setTimeout(() => saveHoldings(), 500);
      }
    };
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ Portfolio Dashboard loading...');
      await testConnection();
      
      // If not connected, use local data
      if (!isConnected) {
        console.log('‚ö†Ô∏è Using local data (no database connection)');
        render();
      }
    });
  </script>

  <!-- Original JavaScript (with modifications for auto-save) -->
  <script>
    // [ALL THE ORIGINAL JAVASCRIPT STAYS HERE]
    const USD_TO_EUR = 0.8462;
    const EUR_TO_USD = 1 / USD_TO_EUR;
    let holdings = [
      // ... original holdings data ...
      { id: 1, name: "Vanguard S&P 500 UCITS ETF", ticker: "VUAA", country: "USA", invested: 2502.99, current: 2712.05, tradeCcy: "EUR" },
      { id: 2, name: "iShares Nasdaq 100 UCITS ETF", ticker: "NQSE", country: "USA", invested: 1638.99, current: 1926.83, tradeCcy: "EUR" },
      // ... rest of holdings ...
    ];
    let nextId = 13;
    let editingId = null;
    let deletingId = null;
    
    // Chart instances
    let allocChart, assetChart, perfChart;
    
    // [ALL THE ORIGINAL FUNCTIONS STAY HERE]
    function render() { /* ... */ }
    function renderMetrics() { /* ... */ }
    function renderTable() { /* ... */ }
    function renderAllocChart() { /* ... */ }
    function renderAssetChart() { /* ... */ }
    function renderPerfChart() { /* ... */ }
    function openAddModal() { /* ... */ }
    function openEditModal(id) { /* ... */ }
    function closeFormModal() { /* ... */ }
    function saveHolding() { /* ... */ }
    function openDeleteModal(id) { /* ... */ }
    function closeDeleteModal() { /* ... */ }
    function confirmDelete() { /* ... */ }
    function toggleMenu(e, id) { /* ... */ }
    function closeMenus() { /* ... */ }
    
    // Initialize
    // Note: We'll call render() from the Supabase initialization
  </script>
</body>
</html>
